AWSTemplateFormatVersion: '2010-09-09'
Description: 'Synth Easy Step function'

Parameters:
  Application:
    Type: String
  Environment:
    Type: String
    AllowedValues:
      - dev
      - stage
      - prod
  ExtractTextLambdaArn:
    Type: String
  GenerateAudioLambdaArn:
    Type: String
  NotifySuccessLambdaArn:
    Type: String
  HandleErrorLambdaArn:
    Type: String

Resources:
  SynthEasyStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: !Sub ${Application}-${Environment}
      StateMachineType: EXPRESS
      DefinitionString: !Sub | 
        {
          "Comment": "SynEasy State Machine",
          "StartAt": "ExtractText",
          "Version": "1.0",
          "States": {
            "ExtractText": {
              "Type": "Task",
              "Resource": "${ExtractTextLambdaArn}",
              "Next": "GenerateAudio"
              "Catch": [
                {
                  "ErrorEquals": [ "States.All" ],
                  "Next": "ErrorHandler"
                  "ResultPath": "$.error"
                }]
            },
            "GenerateAudio": {
              "Type": "Task",
              "Resource": "${GenerateAudioLambdaArn}",
              "Next": "NotifySuccess",
              "Catch": [
              {
                "ErrorEquals": [ "States.All" ],
                "Next": "ErrorHandler"
                "ResultPath": "$.error"
              }]
            },
            "NotifySuccess": {
              "Type": "Task",
              "Resource": "${NotifySuccessLambdaArn}",
              "Next": "Success"
              "Catch": [
              {
                "ErrorEquals": [ "States.All" ],
                "Next": "ErrorHandler"
                "ResultPath": "$.error"
              }]
            },
            "ErrorHandler": {
              Type: "Task",
              "Resource": "${HandleErrorLambdaArn}"
              "Next": "Error"
            },
            "Error": {
              "Type": "Fail"
            },
            "Success": {
              "Type": "Succeed"
            }
          }
        }
      RoleArn: !GetAtt SynthEasyStateMachineRole.Arn


  SynthEasyStateMachineRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: !Sub states.${AWS::Region}.amazonaws.com
          Action: 'sts:AssumeRole'
      Policies:
      - PolicyName: lambda
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: lambda:InvokeFunction
            Resource:
            - !Ref ExtractTextLambdaArn
            - !Ref GenerateAudioLambdaArn
            - !Ref NotifySuccessLambdaArn

Outputs:
  StateMachineArn:
    Value: !Ref SynthEasyStateMachine
